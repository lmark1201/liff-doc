<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>書類送信</title>
  <style>
    body{font-family:system-ui,-apple-system; padding:16px;}
    input,button{font-size:16px; padding:12px; width:100%; box-sizing:border-box;}
    button{margin-top:10px;}
    .msg{margin:10px 0; white-space:pre-wrap;}
    .log{background:#f6f6f6; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <div class="msg" id="msg">起動中...</div>
  <div class="log" id="log"></div>

  <div id="form" style="display:none;">
    <input id="code" placeholder="コードを入力" />
    <button id="send">送信する</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== あなたの値に合わせて ======
    const LIFF_ID = "2006831763-61xmRle3";
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzx463KHzP7rpu2zgd676tAZi0BBgJkweRPOWgNTdprZ1MII1boh52Uo5jbPEePtaAH/exec";
    // =================================

    const msgEl = document.getElementById("msg");
    const logEl = document.getElementById("log");
    const formEl = document.getElementById("form");
    const codeEl = document.getElementById("code");
    const btnEl  = document.getElementById("send");

    function log(s){ logEl.textContent += s + "\n"; }
    function setMsg(s){ msgEl.textContent = s; log("MSG: " + s); }

    // GASへ送信（レスポンスは読まない：CORS/LINE WebView回避）
    async function callApi(payload){
      setMsg("送信中...");
      log("POST " + GAS_ENDPOINT);
      log("payload=" + JSON.stringify(payload));

      try{
        await fetch(GAS_ENDPOINT, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        setMsg("トークに案内を送信しました。");
      } catch(e){
        setMsg("送信に失敗しました（通信制限の可能性）");
        log("ERR: " + String(e));
        throw e;
      }
    }

    log("href=" + location.href);
    log("referrer=" + document.referrer);

    async function main(){
      setMsg("LIFF初期化中...");
      const initPromise = liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error("LIFF init timeout (10s)")), 10000)
      );
      await Promise.race([initPromise, timeoutPromise]);

      log("isInClient=" + liff.isInClient());
      log("isLoggedIn=" + liff.isLoggedIn());

      if (!liff.isLoggedIn()) {
        setMsg("ログイン誘導中...");
        liff.login();
        return;
      }

      setMsg("プロフィール取得中...");
      const profile = await liff.getProfile();
      const userId = profile.userId;
      log("userId=" + userId);

      // ①まず userId だけ送る（登録済みならURLがトークに届く／未登録なら案内が届く）
      await callApi({ userId });

      // ②画面側は常にコード入力を出す（登録済みの人は入力不要。トークにURLが来る）
      setMsg("初回登録の方はコードを入力してください。\n（登録済みの方はトークにURLが届きます）");
      formEl.style.display = "block";

      btnEl.onclick = async () => {
        const code = codeEl.value.trim();
        if (!code) { setMsg("コードを入力してください。"); return; }

        formEl.style.display = "none";
        setMsg("登録して送信中...");

        // ③ code 付きで送る（結果はトークに届く）
        await callApi({ userId, code });

        setMsg("送信しました。トークをご確認ください。");
        setTimeout(()=>liff.closeWindow(), 900);
      };
    }

    main().catch(err=>{
      setMsg("エラーが発生しました");
      log(String(err));
    });
  </script>
</body>
</html>
