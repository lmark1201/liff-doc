<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>書類送信</title>
  <style>
    body{font-family:system-ui,-apple-system; padding:16px;}
    input,button{font-size:16px; padding:12px; width:100%; box-sizing:border-box;}
    button{margin-top:10px;}
    .msg{margin:10px 0; white-space:pre-wrap;}
    .log{background:#f6f6f6; padding:10px; border-radius:8px; font-size:12px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <div class="msg" id="msg">起動中...</div>
  <div class="log" id="log"></div>

  <div id="form" style="display:none;">
    <input id="code" placeholder="コードを入力" />
    <button id="send">送信する</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== あなたの値 ======
    const LIFF_ID = "2006831763-61xmRle3";
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzx463KHzP7rpu2zgd676tAZi0BBgJkweRPOWgNTdprZ1MII1boh52Uo5jbPEePtaAH/exec";
    // =======================

    const msgEl = document.getElementById("msg");
    const logEl = document.getElementById("log");
    const formEl = document.getElementById("form");
    const codeEl = document.getElementById("code");
    const btnEl  = document.getElementById("send");

    function log(s){ logEl.textContent += s + "\n"; }
    function setMsg(s){ msgEl.textContent = s; log("MSG: " + s); }

    log("href=" + location.href);
    log("referrer=" + document.referrer);

    // JSONPでGASに問い合わせ（CORS回避 & modeを受け取れる）
    function callApi(payload){
      return new Promise((resolve, reject) => {
        setMsg("送信中...");

        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        window[cbName] = (data) => {
          try { resolve(data); }
          finally {
            try { delete window[cbName]; } catch(_) {}
            script.remove();
          }
        };

        const params = new URLSearchParams({
          callback: cbName,
          userId: payload.userId || "",
          code: payload.code || ""
        });

        // キャッシュ対策
        const url = GAS_ENDPOINT + "?" + params.toString() + "&t=" + Date.now();
        log("GET(JSONP) " + url);

        const script = document.createElement("script");
        script.src = url;
        script.onerror = () => {
          try { delete window[cbName]; } catch(_) {}
          script.remove();
          reject(new Error("JSONP load failed"));
        };
        document.body.appendChild(script);
      });
    }

    async function main(){
      setMsg("LIFF初期化中...");

      const initPromise = liff.init({
        liffId: LIFF_ID,
        withLoginOnExternalBrowser: true
      });
      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error("LIFF init timeout (10s)")), 10000)
      );
      await Promise.race([initPromise, timeoutPromise]);

      log("isInClient=" + liff.isInClient());
      log("isLoggedIn=" + liff.isLoggedIn());

      if (!liff.isLoggedIn()) {
        setMsg("ログイン誘導中...");
        liff.login();
        return;
      }

      setMsg("プロフィール取得中...");
      const profile = await liff.getProfile();
      const userId = profile.userId;
      log("userId=" + userId);

      // ① 登録済みチェック（GASがトークへPushしつつ mode を返す）
      const r = await callApi({ userId });
      log("mode=" + (r && r.mode));

      // 登録済み：フォーム出さない → すぐ閉じてトークへ戻す
      if (r && r.mode === "known") {
        setMsg("トークに送信しました。");
        setTimeout(() => liff.closeWindow(), 600);
        return;
      }

      // 未登録：フォーム表示
      setMsg("初回登録の方はコードを入力してください。");
      formEl.style.display = "block";

      btnEl.onclick = async () => {
        const code = codeEl.value.trim();
        if (!code) { setMsg("コードを入力してください。"); return; }

        formEl.style.display = "none";
        setMsg("登録して送信中...");

        const rr = await callApi({ userId, code });
        log("mode=" + (rr && rr.mode));

        if (rr && rr.mode === "registered") {
          setMsg("登録してトークに送信しました。");
          setTimeout(() => liff.closeWindow(), 700);
          return;
        }

        // bad_code 等
        setMsg("コードが確認できませんでした。");
        formEl.style.display = "block";
      };
    }

    main().catch(err=>{
      setMsg("エラーが発生しました");
      log(String(err));
    });
  </script>
</body>
</html>
